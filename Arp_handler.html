<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link rel="next" href="Arp_packet.html">
<link rel="Up" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Arp_handler" rel="Chapter" href="Arp_handler.html">
<link title="Arp_packet" rel="Chapter" href="Arp_packet.html">
<link title="Arp_wire" rel="Chapter" href="Arp_wire.html"><link title="Constructor" rel="Section" href="#2_Constructor">
<link title="Predicates" rel="Section" href="#2_Predicates">
<link title="Operations on the cache" rel="Section" href="#2_Operationsonthecache">
<link title="Events" rel="Section" href="#2_Events">
<title>Arp_handler</title>
</head>
<body>
<div class="navbar">&nbsp;<a class="up" href="index.html" title="Index">Up</a>
&nbsp;<a class="post" href="Arp_packet.html" title="Arp_packet">Next</a>
</div>
<h1>Module <a href="type_Arp_handler.html">Arp_handler</a></h1>

<pre><span class="keyword">module</span> Arp_handler: <code class="code"><span class="keyword">sig</span></code> <a href="Arp_handler.html">..</a> <code class="code"><span class="keyword">end</span></code></pre><div class="info module top">
Protocol handler for the Address Resolution Protocol
<p>

    This library provides a pure implementation of ARP, which handles only IPv4
    addresses as protocol and Ethernet (MAC) addresses as hardware.  This is the
    most common usage of ARP currently.  There is no support for other types of
    addresses.  ARP is initially specified in
    <a href="https://tools.ietf.org/html/rfc826">, RFC826</a>, and further refined in
    <a href="https://tools.ietf.org/html/rfc1122">, RFC1122</a> and partially
    <a href="https://tools.ietf.org/html/rfc5227">, RFC5227</a>.
<p>

    The ARP handler consists of a cache, which maps IPv4 addresses to Ethernet
    addresses, and access to it.  Its configuration is set during
    <a href="Arp_handler.html#VALcreate">construction</a>, together with the own IPv4 address and Ethernet
    address.  The cache can be modified with <a href="Arp_handler.html#VALstatic">static</a> entries of other
    hosts, <a href="Arp_handler.html#VALalias">IPv4 aliases</a>, <a href="Arp_handler.html#VALremove">removal</a> of entries.  Outgoing
    frames always use its <a href="Arp_handler.html#VALip">main IPv4 address</a>.  Whether an entry
    <a href="Arp_handler.html#VALin_cache">is available</a> or not can be inspected.
<p>

    The ARP handler can process <a href="Arp_handler.html#VALinput">network input</a>, which may extend the
    cache with dynamic ARP entries which time out after the configured period.
    Periodic calls to <a href="Arp_handler.html#VALtick"><code class="code"><span class="constructor">Arp_handler</span>.tick</code></a> are required for the timeout and retry mechanisms.
    Since ARP usually uses network communication, callers may <a href="Arp_handler.html#VALquery"><code class="code"><span class="constructor">Arp_handler</span>.query</code></a> the cache
    and wait until either a response was received or a timeout occured after
    several retries.
<p>

    The embedded merge strategy is simple: static entries always win (and thus,
    both <a href="Arp_handler.html#VALalias"><code class="code"><span class="constructor">Arp_handler</span>.alias</code></a> and <a href="Arp_handler.html#VALstatic"><code class="code"><span class="constructor">Arp_handler</span>.static</code></a> overwrite existing entries).  Log messages at
    the are generated if an ARP reply wants to overwrite a static entry, or the
    Ethernet address of a dynamic entry changed.
<p>

    ARP frames which should be send on the wire are given as a pair of buffer
    and destination address, to be passed to the underlying layer (usually
    Ethernet).  When adding entries, gratuitous ARP frames are to be sent.
<p>

    While the <a href="Arp_packet.html"><code class="code"><span class="constructor">Arp_packet</span></code></a> module is exposed, for normal operation it is not
    needed, but this module should be sufficient.<br>
</div>
<hr width="100%">

<pre><span id="TYPEt"><span class="keyword">type</span> <code class="type">'a</code> t</span> </pre>
<div class="info ">
The type of an ARP handler.  It is polymorphic over the tasks waiting for
    an ARP reply.<br>
</div>

<br>
<h2 id="2_Constructor">Constructor</h2><br>

<pre><span id="VALcreate"><span class="keyword">val</span> create</span> : <code class="type">?timeout:int -><br>       ?retries:int -><br>       ?logsrc:Logs.src -><br>       Macaddr.t -> Ipaddr.V4.t -> 'a <a href="Arp_handler.html#TYPEt">t</a> * (Cstruct.t * Macaddr.t)</code></pre><div class="info ">
<code class="code">create ~timeout ~retries mac ip)</code> is <code class="code">t, garp</code>.  The constructor of
    the ARP handler, specifying timeouts (defaults to 1200) and amount of
    retries (defaults to 5).  For the given IPv4 address a gratuitous ARP
    request will be encoded in <code class="code">garp</code>.  The value of <code class="code">timeout</code> is the number of
    <code class="code"><span class="constructor">Tick</span></code> events.<br>
<b>Raises</b> <code>Invalid_argument</code> is <code class="code">timeout</code> is 0 or negative or <code class="code">retries</code> is
    negative.<br>
</div>

<pre><span id="VALpp"><span class="keyword">val</span> pp</span> : <code class="type">Format.formatter -> 'a <a href="Arp_handler.html#TYPEt">t</a> -> unit</code></pre><div class="info ">
<code class="code">pp ppf t</code> prints the ARP handler <code class="code">t</code> on <code class="code">ppf</code> by iterating over all cache
    entries.<br>
</div>
<br>
<h2 id="2_Predicates">Predicates</h2><br>

<pre><span id="VALip"><span class="keyword">val</span> ip</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -> Ipaddr.V4.t</code></pre><div class="info ">
<code class="code">ip t</code> is <code class="code">ip</code>, the configured IPv4 address.<br>
</div>

<pre><span id="VALin_cache"><span class="keyword">val</span> in_cache</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -> Ipaddr.V4.t -> Macaddr.t option</code></pre><div class="info ">
<code class="code">in_cache t ip</code> is <code class="code">mac option</code>, a MAC address if the ARP cache contains an
    entry, <code class="code"><span class="constructor">None</span></code> otherwise.<br>
</div>
<br>
<h2 id="2_Operationsonthecache">Operations on the cache</h2><br>

<pre><span id="VALstatic"><span class="keyword">val</span> static</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -> Ipaddr.V4.t -> Macaddr.t -> 'a <a href="Arp_handler.html#TYPEt">t</a> * 'a option</code></pre><div class="info ">
<code class="code">static t ip mac</code> is <code class="code">t', <span class="keyword">as</span></code>, where <code class="code">t'</code> is <code class="code">t</code> extended with a static ARP
    entry using the given <code class="code">ip</code> and <code class="code">mac</code>.  The tasks waiting for <code class="code">ip</code> are
    <code class="code"><span class="keyword">as</span></code>.<br>
</div>

<pre><span id="VALalias"><span class="keyword">val</span> alias</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -><br>       Ipaddr.V4.t -> 'a <a href="Arp_handler.html#TYPEt">t</a> * (Cstruct.t * Macaddr.t) * 'a option</code></pre><div class="info ">
<code class="code">alias t ip</code> is <code class="code">t', out, <span class="keyword">as</span></code>, where <code class="code">t'</code> is <code class="code">t</code> extended by a static ARP
    entry for <code class="code">ip</code>.  This entry will be used to answer further ARP requests.
    <code class="code">out</code> is a gratuitous ARP frame.  The tasks waiting for <code class="code">ip</code> are <code class="code"><span class="keyword">as</span></code>.<br>
</div>

<pre><span id="VALremove"><span class="keyword">val</span> remove</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -> Ipaddr.V4.t -> 'a <a href="Arp_handler.html#TYPEt">t</a></code></pre><div class="info ">
<code class="code">remove t ip</code> is <code class="code">t'</code>, where <code class="code">ip</code> is no longer in the cache.<br>
</div>
<br>
<h2 id="2_Events">Events</h2><br>

<pre><span id="VALtick"><span class="keyword">val</span> tick</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -> 'a <a href="Arp_handler.html#TYPEt">t</a> * (Cstruct.t * Macaddr.t) list * 'a list</code></pre><div class="info ">
<code class="code">tick t</code> is <code class="code">t', requests, timeouts</code>, which advances the state <code class="code">t</code> into
    <code class="code">t'</code>.  Possibly retransmissions of ARP requests need to be done, provided in
    the <code class="code">requests</code> list.  Timed out queries are in the <code class="code">timeouts</code> list.<br>
</div>

<pre><span id="VALinput"><span class="keyword">val</span> input</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -><br>       Cstruct.t -><br>       'a <a href="Arp_handler.html#TYPEt">t</a> * (Cstruct.t * Macaddr.t) option * (Macaddr.t * 'a) option</code></pre><div class="info ">
<code class="code">input t buf</code> is <code class="code">t', reply, w</code>, which handles the input buffer <code class="code">buf</code> in the
    state <code class="code">t</code>.  The state is transformed into <code class="code">t'</code>.  If it was an ARP request
    for one of our IPv4 addresses, an ARP reply should be send out <code class="code">reply</code>.  If
    the input was an awaited ARP reply, some elements <code class="code">w</code> can be informed.<br>
</div>

<pre><code><span id="TYPEqres"><span class="keyword">type</span> <code class="type">'a</code> qres</span> = </code></pre><table class="typetable">
<tr>
<td align="left" valign="top" >
<code><span class="keyword">|</span></code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTqres.Mac"><span class="constructor">Mac</span></span> <span class="keyword">of</span> <code class="type">Macaddr.t</code></code></td>

</tr>
<tr>
<td align="left" valign="top" >
<code><span class="keyword">|</span></code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTqres.Wait"><span class="constructor">Wait</span></span> <span class="keyword">of</span> <code class="type">'a</code></code></td>

</tr>
<tr>
<td align="left" valign="top" >
<code><span class="keyword">|</span></code></td>
<td align="left" valign="top" >
<code><span id="TYPEELTqres.RequestWait"><span class="constructor">RequestWait</span></span> <span class="keyword">of</span> <code class="type">(Cstruct.t * Macaddr.t) * 'a</code></code></td>

</tr></table>

<div class="info ">
The type returned by query, either a <code class="code"><span class="constructor">Mac</span></code> and a mac address, or <code class="code"><span class="constructor">Wait</span></code> for
    a reply, or <code class="code"><span class="constructor">RequestWait</span></code>, consisting of an ARP request to be send on the wire,
    and await its answer.<br>
</div>


<pre><span id="VALquery"><span class="keyword">val</span> query</span> : <code class="type">'a <a href="Arp_handler.html#TYPEt">t</a> -><br>       Ipaddr.V4.t -> ('a option -> 'a) -> 'a <a href="Arp_handler.html#TYPEt">t</a> * 'a <a href="Arp_handler.html#TYPEqres">qres</a></code></pre><div class="info ">
<code class="code">query t ip merge</code> is <code class="code">t', qres</code>, which looks for the <code class="code">ip</code> in the cache.  If
    it is found, its value is <code class="code"><span class="constructor">Mac</span> mac</code>.  If the <code class="code">ip</code> is not in the cache,
    either some <code class="code"><span class="keywordsign">'</span>a</code> is waiting for it already, then the value is <code class="code"><span class="constructor">Wait</span> a</code>,
    where <code class="code">a</code> is produced by applying <code class="code">merge (<span class="constructor">Some</span> <span class="keywordsign">'</span>a)</code> to the waiting thing.
    Otherwise, both an ARP request needs to be send out, and the value of <code class="code">merge
    <span class="constructor">None</span></code> is put into the cache, both as part of <code class="code"><span class="constructor">RequestWait</span></code>.<br>
</div>
</body></html>